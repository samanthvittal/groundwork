# P0.2 UI Templates Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Build all HTML templates and view routes to enable end-to-end testing of authentication, setup wizard, user management, and profile features.

**Architecture:** Jinja2 templates with HTMX for interactivity, view routes that render templates and call existing API services, JetBrains Mono font throughout.

**Tech Stack:** FastAPI, Jinja2, HTMX 2.0.4, CSS custom properties for theming

**Design Doc:** `docs/plans/2026-01-19-p0.2-ui-templates-design.md`

---

## Task 1: Update CSS with JetBrains Mono Font

**Files:**
- Modify: `src/groundwork/static/css/base.css`
- Modify: `src/groundwork/templates/base.html`

**Step 1: Update base.css with JetBrains Mono**

Edit `src/groundwork/static/css/base.css` to update the font-family in `:root`:

```css
:root {
  /* Typography - JetBrains Mono */
  --font-family: 'JetBrains Mono', ui-monospace, SFMono-Regular, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace;
  --font-size-xs: 0.75rem;   /* 12px */
  --font-size-sm: 0.875rem;  /* 14px */
  --font-size-base: 1rem;    /* 16px */
  --font-size-lg: 1.125rem;  /* 18px */
  --font-size-xl: 1.25rem;   /* 20px */
  --font-size-2xl: 1.5rem;   /* 24px */
  --font-size-3xl: 2rem;     /* 32px */
```

**Step 2: Add Google Fonts link to base.html**

Edit `src/groundwork/templates/base.html` to add in the `<head>` section before the CSS links:

```html
<!-- Fonts -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&display=swap" rel="stylesheet">
```

**Step 3: Commit**

```bash
git add src/groundwork/static/css/base.css src/groundwork/templates/base.html
git commit -m "style: add JetBrains Mono font"
```

---

## Task 2: Create Static Assets (Logo, App.js)

**Files:**
- Create: `src/groundwork/static/images/logo.svg`
- Create: `src/groundwork/static/js/app.js`

**Step 1: Create logo.svg**

Create `src/groundwork/static/images/logo.svg`:

```svg
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 40 40" fill="none">
  <rect width="40" height="40" rx="8" fill="#2563eb"/>
  <path d="M12 28V12h4v6h8v-6h4v16h-4v-6h-8v6h-4z" fill="white"/>
</svg>
```

**Step 2: Create app.js**

Create `src/groundwork/static/js/app.js`:

```javascript
/**
 * Groundwork App JavaScript
 * Handles theme toggle, dropdowns, sidebar, and HTMX configuration
 */

// Theme Management
const ThemeManager = {
  init() {
    const saved = localStorage.getItem('theme') || 'system';
    this.apply(saved);
    this.bindToggle();
  },

  apply(theme) {
    const root = document.documentElement;
    if (theme === 'system') {
      const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
      root.setAttribute('data-theme', prefersDark ? 'dark' : 'light');
    } else {
      root.setAttribute('data-theme', theme);
    }
    localStorage.setItem('theme', theme);
    this.updateIcon(theme);
  },

  updateIcon(theme) {
    const icon = document.querySelector('[data-theme-icon]');
    if (!icon) return;
    const isDark = theme === 'dark' ||
      (theme === 'system' && window.matchMedia('(prefers-color-scheme: dark)').matches);
    icon.innerHTML = isDark ? '‚òÄÔ∏è' : 'üåô';
  },

  bindToggle() {
    document.addEventListener('click', (e) => {
      const toggle = e.target.closest('[data-theme-toggle]');
      if (!toggle) return;
      const current = localStorage.getItem('theme') || 'system';
      const next = current === 'light' ? 'dark' : current === 'dark' ? 'system' : 'light';
      this.apply(next);
    });
  }
};

// Dropdown Management
const DropdownManager = {
  init() {
    document.addEventListener('click', (e) => {
      const trigger = e.target.closest('[data-dropdown-trigger]');
      if (trigger) {
        e.preventDefault();
        const dropdown = trigger.closest('[data-dropdown]');
        this.toggle(dropdown);
        return;
      }
      // Close all dropdowns when clicking outside
      if (!e.target.closest('[data-dropdown]')) {
        this.closeAll();
      }
    });

    // Close on escape
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') this.closeAll();
    });
  },

  toggle(dropdown) {
    const isOpen = dropdown.classList.contains('open');
    this.closeAll();
    if (!isOpen) dropdown.classList.add('open');
  },

  closeAll() {
    document.querySelectorAll('[data-dropdown].open').forEach(d => d.classList.remove('open'));
  }
};

// Sidebar Management
const SidebarManager = {
  init() {
    document.addEventListener('click', (e) => {
      const toggle = e.target.closest('[data-sidebar-toggle]');
      if (toggle) {
        document.body.classList.toggle('sidebar-collapsed');
        localStorage.setItem('sidebar-collapsed', document.body.classList.contains('sidebar-collapsed'));
      }

      // Mobile overlay click closes sidebar
      if (e.target.closest('.sidebar-overlay')) {
        document.body.classList.remove('sidebar-open');
      }

      // Mobile menu toggle
      const mobileToggle = e.target.closest('[data-mobile-menu-toggle]');
      if (mobileToggle) {
        document.body.classList.toggle('sidebar-open');
      }
    });

    // Restore sidebar state
    if (localStorage.getItem('sidebar-collapsed') === 'true') {
      document.body.classList.add('sidebar-collapsed');
    }

    // Close mobile sidebar on escape
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        document.body.classList.remove('sidebar-open');
      }
    });
  }
};

// Toast Notifications
const ToastManager = {
  container: null,

  init() {
    this.container = document.getElementById('toast-container');
    if (!this.container) {
      this.container = document.createElement('div');
      this.container.id = 'toast-container';
      this.container.className = 'toast-container';
      document.body.appendChild(this.container);
    }
  },

  show(message, type = 'info', duration = 5000) {
    const toast = document.createElement('div');
    toast.className = `toast toast-${type}`;
    toast.innerHTML = `
      <span class="toast-message">${message}</span>
      <button class="toast-close" onclick="this.parentElement.remove()">√ó</button>
    `;
    this.container.appendChild(toast);

    // Auto dismiss (except errors)
    if (type !== 'error' && duration > 0) {
      setTimeout(() => toast.remove(), duration);
    }

    return toast;
  }
};

// Flash Message Handler (for HTMX responses)
const FlashHandler = {
  init() {
    document.body.addEventListener('htmx:afterSwap', (e) => {
      // Check for flash messages in response headers
      const flash = e.detail.xhr.getResponseHeader('X-Flash-Message');
      const flashType = e.detail.xhr.getResponseHeader('X-Flash-Type') || 'info';
      if (flash) {
        ToastManager.show(decodeURIComponent(flash), flashType);
      }
    });
  }
};

// Password Visibility Toggle
const PasswordToggle = {
  init() {
    document.addEventListener('click', (e) => {
      const toggle = e.target.closest('[data-password-toggle]');
      if (!toggle) return;
      const input = toggle.closest('.input-group').querySelector('input');
      const isPassword = input.type === 'password';
      input.type = isPassword ? 'text' : 'password';
      toggle.textContent = isPassword ? 'üôà' : 'üëÅÔ∏è';
    });
  }
};

// Initialize on DOM ready
document.addEventListener('DOMContentLoaded', () => {
  ThemeManager.init();
  DropdownManager.init();
  SidebarManager.init();
  ToastManager.init();
  FlashHandler.init();
  PasswordToggle.init();
});

// HTMX Configuration
document.body.addEventListener('htmx:configRequest', (e) => {
  // Add CSRF token to all requests
  const csrfToken = document.querySelector('meta[name="csrf-token"]')?.content;
  if (csrfToken) {
    e.detail.headers['X-CSRF-Token'] = csrfToken;
  }
});

// Expose ToastManager globally for use in templates
window.Toast = ToastManager;
```

**Step 3: Commit**

```bash
git add src/groundwork/static/images/logo.svg src/groundwork/static/js/app.js
git commit -m "feat: add logo and app.js with theme, dropdown, sidebar management"
```

---

## Task 3: Create Views Module Structure

**Files:**
- Create: `src/groundwork/views/__init__.py`
- Modify: `src/groundwork/main.py`

**Step 1: Create views module**

Create `src/groundwork/views/__init__.py`:

```python
"""View routes for HTML pages."""

from groundwork.views.auth import router as auth_router
from groundwork.views.profile import router as profile_router
from groundwork.views.roles import router as roles_router
from groundwork.views.setup import router as setup_router
from groundwork.views.users import router as users_router

__all__ = [
    "auth_router",
    "profile_router",
    "roles_router",
    "setup_router",
    "users_router",
]
```

**Step 2: Create placeholder view files**

Create `src/groundwork/views/setup.py`:

```python
"""Setup wizard view routes."""

from fastapi import APIRouter

router = APIRouter()
```

Create `src/groundwork/views/auth.py`:

```python
"""Authentication view routes."""

from fastapi import APIRouter

router = APIRouter()
```

Create `src/groundwork/views/profile.py`:

```python
"""Profile view routes."""

from fastapi import APIRouter

router = APIRouter()
```

Create `src/groundwork/views/users.py`:

```python
"""User management view routes."""

from fastapi import APIRouter

router = APIRouter()
```

Create `src/groundwork/views/roles.py`:

```python
"""Role management view routes."""

from fastapi import APIRouter

router = APIRouter()
```

**Step 3: Update main.py to include view routers**

Edit `src/groundwork/main.py` to add imports and include routers. Add after the API router imports:

```python
from groundwork.views import (
    auth_router as auth_view_router,
    profile_router as profile_view_router,
    roles_router as roles_view_router,
    setup_router as setup_view_router,
    users_router as users_view_router,
)
```

Add in `create_app()` after the API routers:

```python
    # View routes (HTML pages)
    app.include_router(setup_view_router, tags=["setup-views"])
    app.include_router(auth_view_router, tags=["auth-views"])
    app.include_router(profile_view_router, prefix="/profile", tags=["profile-views"])
    app.include_router(users_view_router, prefix="/users", tags=["users-views"])
    app.include_router(roles_view_router, prefix="/roles", tags=["roles-views"])
```

**Step 4: Commit**

```bash
git add src/groundwork/views/ src/groundwork/main.py
git commit -m "feat: add views module structure for HTML pages"
```

---

## Task 4: Setup Wizard Templates

**Files:**
- Create: `src/groundwork/templates/setup/welcome.html`
- Create: `src/groundwork/templates/setup/instance.html`
- Create: `src/groundwork/templates/setup/admin.html`
- Create: `src/groundwork/templates/setup/smtp.html`
- Create: `src/groundwork/templates/setup/complete.html`
- Modify: `src/groundwork/views/setup.py`
- Create: `tests/views/__init__.py`
- Create: `tests/views/test_setup_views.py`

**Step 1: Create setup templates directory**

```bash
mkdir -p src/groundwork/templates/setup
```

**Step 2: Create welcome.html**

Create `src/groundwork/templates/setup/welcome.html`:

```html
{% extends "layouts/public.html" %}

{% block title %}Welcome - Setup{% endblock %}

{% block content %}
<div class="setup-card">
  <div class="setup-progress">
    <span class="step active">1</span>
    <span class="step">2</span>
    <span class="step">3</span>
    <span class="step">4</span>
  </div>

  <div class="setup-icon">
    <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path d="M12 2L2 7l10 5 10-5-10-5z"/>
      <path d="M2 17l10 5 10-5"/>
      <path d="M2 12l10 5 10-5"/>
    </svg>
  </div>

  <h1>Welcome to Groundwork</h1>
  <p class="text-secondary">
    Let's get your workspace set up. This will only take a few minutes.
    We'll configure your instance, create an admin account, and optionally set up email.
  </p>

  <a href="/setup/instance" class="btn btn-primary btn-lg w-full">
    Get Started ‚Üí
  </a>
</div>
{% endblock %}
```

**Step 3: Create instance.html**

Create `src/groundwork/templates/setup/instance.html`:

```html
{% extends "layouts/public.html" %}

{% block title %}Instance Settings - Setup{% endblock %}

{% block content %}
<div class="setup-card">
  <div class="setup-progress">
    <span class="step completed">‚úì</span>
    <span class="step active">2</span>
    <span class="step">3</span>
    <span class="step">4</span>
  </div>

  <h1>Instance Settings</h1>
  <p class="text-secondary">Configure your Groundwork instance.</p>

  <form method="post" action="/setup/instance" class="form">
    <div class="form-group">
      <label for="instance_name">Instance Name <span class="required">*</span></label>
      <input
        type="text"
        id="instance_name"
        name="instance_name"
        placeholder="My Company Workspace"
        value="{{ instance_name or '' }}"
        required
        autofocus
      >
      <span class="help-text">This will be displayed in the header and emails.</span>
    </div>

    <div class="form-group">
      <label for="base_url">Base URL <span class="required">*</span></label>
      <input
        type="url"
        id="base_url"
        name="base_url"
        placeholder="https://groundwork.example.com"
        value="{{ base_url or request.base_url }}"
        required
      >
      <span class="help-text">The URL where Groundwork is hosted.</span>
    </div>

    {% if error %}
    <div class="alert alert-error">{{ error }}</div>
    {% endif %}

    <div class="form-actions">
      <a href="/setup" class="btn btn-ghost">‚Üê Back</a>
      <button type="submit" class="btn btn-primary">Continue ‚Üí</button>
    </div>
  </form>
</div>
{% endblock %}
```

**Step 4: Create admin.html**

Create `src/groundwork/templates/setup/admin.html`:

```html
{% extends "layouts/public.html" %}

{% block title %}Admin Account - Setup{% endblock %}

{% block content %}
<div class="setup-card">
  <div class="setup-progress">
    <span class="step completed">‚úì</span>
    <span class="step completed">‚úì</span>
    <span class="step active">3</span>
    <span class="step">4</span>
  </div>

  <h1>Create Admin Account</h1>
  <p class="text-secondary">Set up the administrator account for your instance.</p>

  <form method="post" action="/setup/admin" class="form">
    <div class="form-group">
      <label for="email">Email <span class="required">*</span></label>
      <div class="input-group">
        <span class="input-icon">üìß</span>
        <input
          type="email"
          id="email"
          name="email"
          placeholder="admin@example.com"
          value="{{ email or '' }}"
          required
          autofocus
        >
      </div>
    </div>

    <div class="form-row">
      <div class="form-group">
        <label for="first_name">First Name <span class="required">*</span></label>
        <input
          type="text"
          id="first_name"
          name="first_name"
          placeholder="John"
          value="{{ first_name or '' }}"
          required
        >
      </div>

      <div class="form-group">
        <label for="last_name">Last Name <span class="required">*</span></label>
        <input
          type="text"
          id="last_name"
          name="last_name"
          placeholder="Doe"
          value="{{ last_name or '' }}"
          required
        >
      </div>
    </div>

    <div class="form-group">
      <label for="password">Password <span class="required">*</span></label>
      <div class="input-group">
        <span class="input-icon">üîí</span>
        <input
          type="password"
          id="password"
          name="password"
          placeholder="Minimum 8 characters"
          minlength="8"
          required
        >
        <button type="button" class="input-action" data-password-toggle>üëÅÔ∏è</button>
      </div>
      <span class="help-text">At least 8 characters.</span>
    </div>

    <div class="form-group">
      <label for="password_confirm">Confirm Password <span class="required">*</span></label>
      <div class="input-group">
        <span class="input-icon">üîí</span>
        <input
          type="password"
          id="password_confirm"
          name="password_confirm"
          placeholder="Confirm your password"
          minlength="8"
          required
        >
        <button type="button" class="input-action" data-password-toggle>üëÅÔ∏è</button>
      </div>
    </div>

    {% if error %}
    <div class="alert alert-error">{{ error }}</div>
    {% endif %}

    <div class="form-actions">
      <a href="/setup/instance" class="btn btn-ghost">‚Üê Back</a>
      <button type="submit" class="btn btn-primary">Continue ‚Üí</button>
    </div>
  </form>
</div>
{% endblock %}
```

**Step 5: Create smtp.html**

Create `src/groundwork/templates/setup/smtp.html`:

```html
{% extends "layouts/public.html" %}

{% block title %}Email Configuration - Setup{% endblock %}

{% block content %}
<div class="setup-card">
  <div class="setup-progress">
    <span class="step completed">‚úì</span>
    <span class="step completed">‚úì</span>
    <span class="step completed">‚úì</span>
    <span class="step active">4</span>
  </div>

  <h1>Email Configuration</h1>
  <p class="text-secondary">
    Configure SMTP to enable password reset emails.
    <span class="badge badge-info">Optional</span>
  </p>

  <form method="post" action="/setup/smtp" class="form">
    <div class="form-row">
      <div class="form-group flex-2">
        <label for="smtp_host">SMTP Host</label>
        <input
          type="text"
          id="smtp_host"
          name="smtp_host"
          placeholder="smtp.example.com"
          value="{{ smtp_host or '' }}"
        >
      </div>

      <div class="form-group flex-1">
        <label for="smtp_port">Port</label>
        <input
          type="number"
          id="smtp_port"
          name="smtp_port"
          placeholder="587"
          value="{{ smtp_port or '587' }}"
        >
      </div>
    </div>

    <div class="form-row">
      <div class="form-group">
        <label for="smtp_username">Username</label>
        <input
          type="text"
          id="smtp_username"
          name="smtp_username"
          placeholder="username"
          value="{{ smtp_username or '' }}"
        >
      </div>

      <div class="form-group">
        <label for="smtp_password">Password</label>
        <input
          type="password"
          id="smtp_password"
          name="smtp_password"
          placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
        >
      </div>
    </div>

    <div class="form-group">
      <label for="smtp_from_address">From Address</label>
      <input
        type="email"
        id="smtp_from_address"
        name="smtp_from_address"
        placeholder="noreply@example.com"
        value="{{ smtp_from_address or '' }}"
      >
    </div>

    {% if error %}
    <div class="alert alert-error">{{ error }}</div>
    {% endif %}

    {% if success %}
    <div class="alert alert-success">{{ success }}</div>
    {% endif %}

    <div class="form-actions">
      <a href="/setup/admin" class="btn btn-ghost">‚Üê Back</a>
      <div class="btn-group">
        <a href="/setup/complete" class="btn btn-secondary">Skip for Now</a>
        <button type="submit" class="btn btn-primary">Save & Complete</button>
      </div>
    </div>
  </form>
</div>
{% endblock %}
```

**Step 6: Create complete.html**

Create `src/groundwork/templates/setup/complete.html`:

```html
{% extends "layouts/public.html" %}

{% block title %}Setup Complete{% endblock %}

{% block content %}
<div class="setup-card text-center">
  <div class="success-icon">
    <svg xmlns="http://www.w3.org/2000/svg" width="80" height="80" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="text-success">
      <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
      <polyline points="22 4 12 14.01 9 11.01"/>
    </svg>
  </div>

  <h1>Groundwork is Ready!</h1>
  <p class="text-secondary">Your instance has been configured successfully.</p>

  <div class="setup-summary">
    <div class="summary-item">
      <span class="label">Instance</span>
      <span class="value">{{ instance_name }}</span>
    </div>
    <div class="summary-item">
      <span class="label">Admin</span>
      <span class="value">{{ admin_email }}</span>
    </div>
    <div class="summary-item">
      <span class="label">Email</span>
      <span class="value">{{ 'Configured' if smtp_configured else 'Not configured' }}</span>
    </div>
  </div>

  <a href="/login" class="btn btn-primary btn-lg">
    Go to Login ‚Üí
  </a>
</div>
{% endblock %}
```

**Step 7: Implement setup view routes**

Edit `src/groundwork/views/setup.py`:

```python
"""Setup wizard view routes."""

from typing import Annotated

from fastapi import APIRouter, Depends, Form, Request
from fastapi.responses import HTMLResponse, RedirectResponse
from sqlalchemy.ext.asyncio import AsyncSession

from groundwork.core.database import get_db
from groundwork.main import get_templates
from groundwork.setup.services import SetupService

router = APIRouter()


async def get_setup_service(db: Annotated[AsyncSession, Depends(get_db)]) -> SetupService:
    """Get setup service instance."""
    return SetupService(db)


@router.get("/setup", response_class=HTMLResponse)
async def setup_welcome(
    request: Request,
    service: Annotated[SetupService, Depends(get_setup_service)],
):
    """Setup welcome page."""
    status = await service.get_setup_status()
    if status["setup_completed"]:
        return RedirectResponse(url="/login", status_code=303)

    templates = get_templates()
    return templates.TemplateResponse(
        request=request,
        name="setup/welcome.html",
    )


@router.get("/setup/instance", response_class=HTMLResponse)
async def setup_instance_form(
    request: Request,
    service: Annotated[SetupService, Depends(get_setup_service)],
):
    """Instance settings form."""
    status = await service.get_setup_status()
    if status["setup_completed"]:
        return RedirectResponse(url="/login", status_code=303)

    templates = get_templates()
    return templates.TemplateResponse(
        request=request,
        name="setup/instance.html",
        context={"base_url": str(request.base_url).rstrip("/")},
    )


@router.post("/setup/instance", response_class=HTMLResponse)
async def setup_instance_submit(
    request: Request,
    service: Annotated[SetupService, Depends(get_setup_service)],
    instance_name: Annotated[str, Form()],
    base_url: Annotated[str, Form()],
):
    """Process instance settings."""
    try:
        await service.save_instance_settings(instance_name, base_url)
        return RedirectResponse(url="/setup/admin", status_code=303)
    except Exception as e:
        templates = get_templates()
        return templates.TemplateResponse(
            request=request,
            name="setup/instance.html",
            context={
                "error": str(e),
                "instance_name": instance_name,
                "base_url": base_url,
            },
        )


@router.get("/setup/admin", response_class=HTMLResponse)
async def setup_admin_form(
    request: Request,
    service: Annotated[SetupService, Depends(get_setup_service)],
):
    """Admin account form."""
    status = await service.get_setup_status()
    if status["setup_completed"]:
        return RedirectResponse(url="/login", status_code=303)
    if status["current_step"] == "welcome":
        return RedirectResponse(url="/setup/instance", status_code=303)

    templates = get_templates()
    return templates.TemplateResponse(
        request=request,
        name="setup/admin.html",
    )


@router.post("/setup/admin", response_class=HTMLResponse)
async def setup_admin_submit(
    request: Request,
    service: Annotated[SetupService, Depends(get_setup_service)],
    email: Annotated[str, Form()],
    first_name: Annotated[str, Form()],
    last_name: Annotated[str, Form()],
    password: Annotated[str, Form()],
    password_confirm: Annotated[str, Form()],
):
    """Process admin account creation."""
    templates = get_templates()

    if password != password_confirm:
        return templates.TemplateResponse(
            request=request,
            name="setup/admin.html",
            context={
                "error": "Passwords do not match",
                "email": email,
                "first_name": first_name,
                "last_name": last_name,
            },
        )

    if len(password) < 8:
        return templates.TemplateResponse(
            request=request,
            name="setup/admin.html",
            context={
                "error": "Password must be at least 8 characters",
                "email": email,
                "first_name": first_name,
                "last_name": last_name,
            },
        )

    try:
        result = await service.create_admin_user(email, first_name, last_name, password)
        if result is None:
            return templates.TemplateResponse(
                request=request,
                name="setup/admin.html",
                context={
                    "error": "Admin user already exists",
                    "email": email,
                    "first_name": first_name,
                    "last_name": last_name,
                },
            )
        return RedirectResponse(url="/setup/smtp", status_code=303)
    except Exception as e:
        return templates.TemplateResponse(
            request=request,
            name="setup/admin.html",
            context={
                "error": str(e),
                "email": email,
                "first_name": first_name,
                "last_name": last_name,
            },
        )


@router.get("/setup/smtp", response_class=HTMLResponse)
async def setup_smtp_form(
    request: Request,
    service: Annotated[SetupService, Depends(get_setup_service)],
):
    """SMTP configuration form."""
    status = await service.get_setup_status()
    if status["setup_completed"]:
        return RedirectResponse(url="/login", status_code=303)
    if status["current_step"] in ["welcome", "admin"]:
        return RedirectResponse(url="/setup", status_code=303)

    templates = get_templates()
    return templates.TemplateResponse(
        request=request,
        name="setup/smtp.html",
    )


@router.post("/setup/smtp", response_class=HTMLResponse)
async def setup_smtp_submit(
    request: Request,
    service: Annotated[SetupService, Depends(get_setup_service)],
    smtp_host: Annotated[str, Form()],
    smtp_port: Annotated[int, Form()],
    smtp_username: Annotated[str | None, Form()] = None,
    smtp_password: Annotated[str | None, Form()] = None,
    smtp_from_address: Annotated[str, Form()] = "",
):
    """Process SMTP configuration."""
    try:
        await service.configure_smtp(
            smtp_host=smtp_host,
            smtp_port=smtp_port,
            smtp_username=smtp_username,
            smtp_password=smtp_password,
            smtp_from_address=smtp_from_address,
        )
        await service.complete_setup()
        return RedirectResponse(url="/setup/complete", status_code=303)
    except Exception as e:
        templates = get_templates()
        return templates.TemplateResponse(
            request=request,
            name="setup/smtp.html",
            context={
                "error": str(e),
                "smtp_host": smtp_host,
                "smtp_port": smtp_port,
                "smtp_username": smtp_username,
                "smtp_from_address": smtp_from_address,
            },
        )


@router.get("/setup/complete", response_class=HTMLResponse)
async def setup_complete(
    request: Request,
    service: Annotated[SetupService, Depends(get_setup_service)],
):
    """Setup complete page."""
    # Complete setup if not already done (for skip SMTP flow)
    status = await service.get_setup_status()
    if not status["setup_completed"]:
        await service.complete_setup()

    config = await service._get_instance_config()
    admin = await service._get_admin_user()

    templates = get_templates()
    return templates.TemplateResponse(
        request=request,
        name="setup/complete.html",
        context={
            "instance_name": config.instance_name if config else "Groundwork",
            "admin_email": admin.email if admin else "Unknown",
            "smtp_configured": config.smtp_configured if config else False,
        },
    )
```

**Step 8: Create view tests**

Create `tests/views/__init__.py`:

```python
"""Tests for view routes."""
```

Create `tests/views/test_setup_views.py`:

```python
"""Tests for setup wizard views."""

import pytest
from httpx import AsyncClient


@pytest.mark.asyncio
async def test_setup_welcome_returns_html(client: AsyncClient) -> None:
    """GET /setup should return welcome page HTML."""
    response = await client.get("/setup", follow_redirects=False)
    # Should either return 200 with HTML or redirect to login if setup complete
    assert response.status_code in [200, 303]


@pytest.mark.asyncio
async def test_setup_instance_returns_html(client: AsyncClient) -> None:
    """GET /setup/instance should return instance form HTML."""
    response = await client.get("/setup/instance", follow_redirects=False)
    assert response.status_code in [200, 303]


@pytest.mark.asyncio
async def test_setup_admin_returns_html(client: AsyncClient) -> None:
    """GET /setup/admin should return admin form HTML."""
    response = await client.get("/setup/admin", follow_redirects=False)
    assert response.status_code in [200, 303]


@pytest.mark.asyncio
async def test_setup_smtp_returns_html(client: AsyncClient) -> None:
    """GET /setup/smtp should return SMTP form HTML."""
    response = await client.get("/setup/smtp", follow_redirects=False)
    assert response.status_code in [200, 303]
```

**Step 9: Run tests**

```bash
uv run pytest tests/views/test_setup_views.py -v
```

**Step 10: Commit**

```bash
git add src/groundwork/templates/setup/ src/groundwork/views/setup.py tests/views/
git commit -m "feat: add setup wizard templates and view routes"
```

---

## Task 5: Auth Templates (Login, Password Reset)

**Files:**
- Create: `src/groundwork/templates/auth/login.html`
- Create: `src/groundwork/templates/auth/password_reset.html`
- Create: `src/groundwork/templates/auth/password_reset_confirm.html`
- Modify: `src/groundwork/views/auth.py`
- Create: `tests/views/test_auth_views.py`

**Step 1: Create auth templates directory**

```bash
mkdir -p src/groundwork/templates/auth
```

**Step 2: Create login.html**

Create `src/groundwork/templates/auth/login.html`:

```html
{% extends "layouts/public.html" %}

{% block title %}Sign In{% endblock %}

{% block content %}
<div class="auth-card">
  <h1>Sign In</h1>
  <p class="text-secondary">Welcome back! Please sign in to continue.</p>

  {% if error %}
  <div class="alert alert-error">{{ error }}</div>
  {% endif %}

  <form method="post" action="/login" class="form">
    <div class="form-group">
      <label for="email">Email</label>
      <div class="input-group">
        <span class="input-icon">üìß</span>
        <input
          type="email"
          id="email"
          name="email"
          placeholder="you@example.com"
          value="{{ email or '' }}"
          required
          autofocus
        >
      </div>
    </div>

    <div class="form-group">
      <label for="password">Password</label>
      <div class="input-group">
        <span class="input-icon">üîí</span>
        <input
          type="password"
          id="password"
          name="password"
          placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
          required
        >
        <button type="button" class="input-action" data-password-toggle>üëÅÔ∏è</button>
      </div>
    </div>

    <button type="submit" class="btn btn-primary btn-lg w-full">
      Sign In
    </button>
  </form>

  {% if smtp_configured %}
  <div class="auth-links">
    <a href="/forgot-password">Forgot your password?</a>
  </div>
  {% endif %}
</div>
{% endblock %}
```

**Step 3: Create password_reset.html**

Create `src/groundwork/templates/auth/password_reset.html`:

```html
{% extends "layouts/public.html" %}

{% block title %}Reset Password{% endblock %}

{% block content %}
<div class="auth-card">
  {% if success %}
  <div class="text-center">
    <div class="success-icon">
      <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="text-success">
        <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/>
        <polyline points="22,6 12,13 2,6"/>
      </svg>
    </div>
    <h1>Check Your Email</h1>
    <p class="text-secondary">
      If an account exists for {{ email }}, you will receive a password reset link shortly.
    </p>
    <a href="/login" class="btn btn-primary">Back to Login</a>
  </div>
  {% else %}
  <h1>Reset Password</h1>
  <p class="text-secondary">Enter your email and we'll send you a reset link.</p>

  {% if error %}
  <div class="alert alert-error">{{ error }}</div>
  {% endif %}

  <form method="post" action="/forgot-password" class="form">
    <div class="form-group">
      <label for="email">Email</label>
      <div class="input-group">
        <span class="input-icon">üìß</span>
        <input
          type="email"
          id="email"
          name="email"
          placeholder="you@example.com"
          value="{{ email or '' }}"
          required
          autofocus
        >
      </div>
    </div>

    <button type="submit" class="btn btn-primary btn-lg w-full">
      Send Reset Link
    </button>
  </form>

  <div class="auth-links">
    <a href="/login">‚Üê Back to Login</a>
  </div>
  {% endif %}
</div>
{% endblock %}
```

**Step 4: Create password_reset_confirm.html**

Create `src/groundwork/templates/auth/password_reset_confirm.html`:

```html
{% extends "layouts/public.html" %}

{% block title %}Set New Password{% endblock %}

{% block content %}
<div class="auth-card">
  {% if success %}
  <div class="text-center">
    <div class="success-icon">
      <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="text-success">
        <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
        <polyline points="22 4 12 14.01 9 11.01"/>
      </svg>
    </div>
    <h1>Password Updated!</h1>
    <p class="text-secondary">Your password has been successfully reset.</p>
    <a href="/login" class="btn btn-primary btn-lg">Go to Login</a>
  </div>
  {% elif invalid_token %}
  <div class="text-center">
    <div class="error-icon">
      <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="text-error">
        <circle cx="12" cy="12" r="10"/>
        <line x1="15" y1="9" x2="9" y2="15"/>
        <line x1="9" y1="9" x2="15" y2="15"/>
      </svg>
    </div>
    <h1>Invalid or Expired Link</h1>
    <p class="text-secondary">This password reset link is invalid or has expired.</p>
    <a href="/forgot-password" class="btn btn-primary">Request New Link</a>
  </div>
  {% else %}
  <h1>Set New Password</h1>
  <p class="text-secondary">Enter your new password below.</p>

  {% if error %}
  <div class="alert alert-error">{{ error }}</div>
  {% endif %}

  <form method="post" action="/reset-password/{{ token }}" class="form">
    <div class="form-group">
      <label for="password">New Password</label>
      <div class="input-group">
        <span class="input-icon">üîí</span>
        <input
          type="password"
          id="password"
          name="password"
          placeholder="Minimum 8 characters"
          minlength="8"
          required
          autofocus
        >
        <button type="button" class="input-action" data-password-toggle>üëÅÔ∏è</button>
      </div>
    </div>

    <div class="form-group">
      <label for="password_confirm">Confirm Password</label>
      <div class="input-group">
        <span class="input-icon">üîí</span>
        <input
          type="password"
          id="password_confirm"
          name="password_confirm"
          placeholder="Confirm your password"
          minlength="8"
          required
        >
        <button type="button" class="input-action" data-password-toggle>üëÅÔ∏è</button>
      </div>
    </div>

    <button type="submit" class="btn btn-primary btn-lg w-full">
      Reset Password
    </button>
  </form>
  {% endif %}
</div>
{% endblock %}
```

**Step 5: Implement auth view routes**

Edit `src/groundwork/views/auth.py`:

```python
"""Authentication view routes."""

from typing import Annotated

from fastapi import APIRouter, Depends, Form, Request
from fastapi.responses import HTMLResponse, RedirectResponse, Response
from sqlalchemy.ext.asyncio import AsyncSession

from groundwork.auth.services import AuthService
from groundwork.auth.dependencies import get_current_user_optional
from groundwork.auth.models import User
from groundwork.core.database import get_db
from groundwork.main import get_templates
from groundwork.setup.services import SetupService

router = APIRouter()


@router.get("/login", response_class=HTMLResponse)
async def login_form(
    request: Request,
    db: Annotated[AsyncSession, Depends(get_db)],
    current_user: Annotated[User | None, Depends(get_current_user_optional)] = None,
):
    """Login page."""
    if current_user:
        return RedirectResponse(url="/users", status_code=303)

    setup_service = SetupService(db)
    config = await setup_service._get_instance_config()

    templates = get_templates()
    return templates.TemplateResponse(
        request=request,
        name="auth/login.html",
        context={
            "smtp_configured": config.smtp_configured if config else False,
        },
    )


@router.post("/login", response_class=HTMLResponse)
async def login_submit(
    request: Request,
    db: Annotated[AsyncSession, Depends(get_db)],
    email: Annotated[str, Form()],
    password: Annotated[str, Form()],
):
    """Process login."""
    auth_service = AuthService(db)
    setup_service = SetupService(db)
    config = await setup_service._get_instance_config()
    templates = get_templates()

    result = await auth_service.login(email, password)

    if result is None:
        return templates.TemplateResponse(
            request=request,
            name="auth/login.html",
            context={
                "error": "Invalid email or password",
                "email": email,
                "smtp_configured": config.smtp_configured if config else False,
            },
        )

    # Set cookies and redirect
    response = RedirectResponse(url="/users", status_code=303)
    response.set_cookie(
        key="access_token",
        value=result["access_token"],
        httponly=True,
        secure=request.url.scheme == "https",
        samesite="lax",
        max_age=900,  # 15 minutes
    )
    response.set_cookie(
        key="refresh_token",
        value=result["refresh_token"],
        httponly=True,
        secure=request.url.scheme == "https",
        samesite="lax",
        max_age=604800,  # 7 days
    )
    return response


@router.get("/logout")
async def logout(
    request: Request,
    db: Annotated[AsyncSession, Depends(get_db)],
):
    """Logout and clear cookies."""
    auth_service = AuthService(db)

    # Try to revoke refresh token
    refresh_token = request.cookies.get("refresh_token")
    if refresh_token:
        await auth_service.logout(refresh_token)

    response = RedirectResponse(url="/login", status_code=303)
    response.delete_cookie("access_token")
    response.delete_cookie("refresh_token")
    return response


@router.get("/forgot-password", response_class=HTMLResponse)
async def forgot_password_form(
    request: Request,
    db: Annotated[AsyncSession, Depends(get_db)],
):
    """Password reset request page."""
    setup_service = SetupService(db)
    config = await setup_service._get_instance_config()

    # If SMTP not configured, redirect to login
    if not config or not config.smtp_configured:
        return RedirectResponse(url="/login", status_code=303)

    templates = get_templates()
    return templates.TemplateResponse(
        request=request,
        name="auth/password_reset.html",
    )


@router.post("/forgot-password", response_class=HTMLResponse)
async def forgot_password_submit(
    request: Request,
    db: Annotated[AsyncSession, Depends(get_db)],
    email: Annotated[str, Form()],
):
    """Process password reset request."""
    auth_service = AuthService(db)

    # Always show success to prevent email enumeration
    await auth_service.request_password_reset(email)

    templates = get_templates()
    return templates.TemplateResponse(
        request=request,
        name="auth/password_reset.html",
        context={
            "success": True,
            "email": email,
        },
    )


@router.get("/reset-password/{token}", response_class=HTMLResponse)
async def reset_password_form(
    request: Request,
    token: str,
):
    """Password reset confirmation page."""
    templates = get_templates()
    return templates.TemplateResponse(
        request=request,
        name="auth/password_reset_confirm.html",
        context={"token": token},
    )


@router.post("/reset-password/{token}", response_class=HTMLResponse)
async def reset_password_submit(
    request: Request,
    token: str,
    db: Annotated[AsyncSession, Depends(get_db)],
    password: Annotated[str, Form()],
    password_confirm: Annotated[str, Form()],
):
    """Process password reset."""
    templates = get_templates()

    if password != password_confirm:
        return templates.TemplateResponse(
            request=request,
            name="auth/password_reset_confirm.html",
            context={
                "token": token,
                "error": "Passwords do not match",
            },
        )

    if len(password) < 8:
        return templates.TemplateResponse(
            request=request,
            name="auth/password_reset_confirm.html",
            context={
                "token": token,
                "error": "Password must be at least 8 characters",
            },
        )

    auth_service = AuthService(db)
    success = await auth_service.confirm_password_reset(token, password)

    if not success:
        return templates.TemplateResponse(
            request=request,
            name="auth/password_reset_confirm.html",
            context={"invalid_token": True},
        )

    return templates.TemplateResponse(
        request=request,
        name="auth/password_reset_confirm.html",
        context={"success": True},
    )
```

**Step 6: Add get_current_user_optional dependency**

Edit `src/groundwork/auth/dependencies.py` to add:

```python
async def get_current_user_optional(
    request: Request,
    db: Annotated[AsyncSession, Depends(get_db)],
) -> User | None:
    """Get current user if logged in, otherwise None."""
    try:
        return await get_current_user(request, db)
    except HTTPException:
        return None
```

**Step 7: Create auth view tests**

Create `tests/views/test_auth_views.py`:

```python
"""Tests for auth views."""

import pytest
from httpx import AsyncClient


@pytest.mark.asyncio
async def test_login_page_returns_html(client: AsyncClient) -> None:
    """GET /login should return login page HTML."""
    response = await client.get("/login", follow_redirects=False)
    assert response.status_code in [200, 303]


@pytest.mark.asyncio
async def test_logout_redirects_to_login(client: AsyncClient) -> None:
    """GET /logout should redirect to login."""
    response = await client.get("/logout", follow_redirects=False)
    assert response.status_code == 303
    assert response.headers.get("location") == "/login"
```

**Step 8: Run tests**

```bash
uv run pytest tests/views/test_auth_views.py -v
```

**Step 9: Commit**

```bash
git add src/groundwork/templates/auth/ src/groundwork/views/auth.py src/groundwork/auth/dependencies.py tests/views/test_auth_views.py
git commit -m "feat: add auth templates and view routes (login, password reset)"
```

---

## Task 6: Profile Templates

**Files:**
- Create: `src/groundwork/templates/profile/view.html`
- Create: `src/groundwork/templates/profile/edit.html`
- Create: `src/groundwork/templates/profile/settings.html`
- Modify: `src/groundwork/views/profile.py`
- Create: `tests/views/test_profile_views.py`

*(Implementation continues with similar pattern for profile, users, and roles templates)*

---

## Task 7: User Management Templates

**Files:**
- Create: `src/groundwork/templates/users/list.html`
- Create: `src/groundwork/templates/users/detail.html`
- Create: `src/groundwork/templates/users/create.html`
- Create: `src/groundwork/templates/users/edit.html`
- Modify: `src/groundwork/views/users.py`
- Create: `tests/views/test_users_views.py`

---

## Task 8: Role Management Templates

**Files:**
- Create: `src/groundwork/templates/roles/list.html`
- Create: `src/groundwork/templates/roles/detail.html`
- Create: `src/groundwork/templates/roles/create.html`
- Create: `src/groundwork/templates/roles/edit.html`
- Modify: `src/groundwork/views/roles.py`
- Create: `tests/views/test_roles_views.py`

---

## Task 9: Update CSS Components

**Files:**
- Modify: `src/groundwork/static/css/components.css`
- Modify: `src/groundwork/static/css/layout.css`

Add styles for:
- Setup wizard progress indicator
- Auth card styling
- Form improvements (input groups, help text)
- Toast container positioning (bottom-right)

---

## Task 10: Final Integration and Testing

**Steps:**
1. Run full test suite: `uv run pytest tests/ -v`
2. Run linter: `uv run ruff check src/ tests/`
3. Run type checker: `uv run mypy src/groundwork/`
4. Manual E2E test: Start server and walk through setup wizard ‚Üí login ‚Üí user management

**Commit:**
```bash
git add -A
git commit -m "feat: complete P0.2 UI templates implementation"
```

---

## Deliverables Checklist

- [ ] JetBrains Mono font integrated
- [ ] Logo SVG created
- [ ] app.js with theme, dropdown, sidebar, toast management
- [ ] Setup wizard templates (5 pages)
- [ ] Auth templates (3 pages)
- [ ] Profile templates (3 pages)
- [ ] User management templates (4 pages)
- [ ] Role management templates (4 pages)
- [ ] View routes for all HTML pages
- [ ] View route tests
- [ ] All tests passing
- [ ] Manual E2E testing complete
