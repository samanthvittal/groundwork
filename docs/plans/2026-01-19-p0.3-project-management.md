# P0.3 - Project Management Core Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Implement project management - create/edit/delete projects with membership and roles

**Architecture:** Repository pattern for data, Service layer for business logic, FastAPI routes for API, Jinja2 templates for UI

**Tech Stack:** FastAPI, SQLAlchemy 2.0 async, PostgreSQL, HTMX, Jinja2

**Depends On:** P0.2 Authentication (completed)

**Estimated Effort:** 1.5 weeks

---

## Overview

P0.3 adds the ability for users to:
- Create and manage projects
- Add/remove team members to projects
- Assign project-level roles (Owner, Admin, Member, Viewer)
- Archive/restore projects

---

## Task 1: Project Data Layer (P0.3.1)

**Files to create:**
- `src/groundwork/projects/__init__.py`
- `src/groundwork/projects/models.py`
- `src/groundwork/projects/schemas.py`
- `src/groundwork/projects/repository.py`
- `alembic/versions/xxxx_add_projects.py`

### Step 1.1: Create Project Model

```python
# src/groundwork/projects/models.py
class ProjectStatus(str, Enum):
    ACTIVE = "active"
    ARCHIVED = "archived"
    DELETED = "deleted"

class ProjectVisibility(str, Enum):
    PRIVATE = "private"
    INTERNAL = "internal"  # All logged-in users
    PUBLIC = "public"

class Project(Base):
    __tablename__ = "projects"

    id: Mapped[UUID]
    key: Mapped[str]  # Unique, uppercase, e.g., "PROJ"
    name: Mapped[str]
    description: Mapped[str | None]
    visibility: Mapped[ProjectVisibility]
    status: Mapped[ProjectStatus]
    owner_id: Mapped[UUID]  # FK to users
    created_at: Mapped[datetime]
    updated_at: Mapped[datetime]
    archived_at: Mapped[datetime | None]
```

### Step 1.2: Create ProjectMember Model

```python
class ProjectRole(str, Enum):
    OWNER = "owner"
    ADMIN = "admin"
    MEMBER = "member"
    VIEWER = "viewer"

class ProjectMember(Base):
    __tablename__ = "project_members"

    id: Mapped[UUID]
    project_id: Mapped[UUID]  # FK to projects
    user_id: Mapped[UUID]  # FK to users
    role: Mapped[ProjectRole]
    joined_at: Mapped[datetime]
```

### Step 1.3: Create Pydantic Schemas

```python
# src/groundwork/projects/schemas.py
class ProjectCreate(BaseModel):
    key: str  # Validated: uppercase, alphanumeric, 2-10 chars
    name: str
    description: str | None = None
    visibility: ProjectVisibility = ProjectVisibility.PRIVATE

class ProjectUpdate(BaseModel):
    name: str | None = None
    description: str | None = None
    visibility: ProjectVisibility | None = None

class ProjectResponse(BaseModel):
    id: UUID
    key: str
    name: str
    description: str | None
    visibility: ProjectVisibility
    status: ProjectStatus
    owner_id: UUID
    created_at: datetime
    member_count: int
```

### Step 1.4: Create Repository

```python
# src/groundwork/projects/repository.py
class ProjectRepository:
    async def create(self, project: Project) -> Project
    async def get_by_id(self, id: UUID) -> Project | None
    async def get_by_key(self, key: str) -> Project | None
    async def list_for_user(self, user_id: UUID) -> list[Project]
    async def update(self, project: Project) -> Project
    async def delete(self, id: UUID) -> bool
```

### Step 1.5: Create Migration

```bash
uv run alembic revision --autogenerate -m "add projects and project_members"
uv run alembic upgrade head
```

---

## Task 2: Project Service Layer (P0.3.2)

**Files to create:**
- `src/groundwork/projects/services.py`

### Step 2.1: ProjectService Class

```python
class ProjectService:
    def __init__(self, db: AsyncSession):
        self.db = db
        self.repo = ProjectRepository(db)

    async def create_project(
        self,
        data: ProjectCreate,
        owner: User
    ) -> Project:
        """Create project and add owner as member."""
        # Validate key uniqueness
        # Create project
        # Add owner as ProjectMember with OWNER role

    async def update_project(
        self,
        project: Project,
        data: ProjectUpdate,
        user: User
    ) -> Project:
        """Update project (requires admin+ role)."""

    async def archive_project(self, project: Project, user: User) -> Project:
        """Archive project (owner only)."""

    async def restore_project(self, project: Project, user: User) -> Project:
        """Restore archived project."""

    async def delete_project(self, project: Project, user: User) -> bool:
        """Soft delete project (owner only)."""
```

### Step 2.2: Membership Management

```python
    async def add_member(
        self,
        project: Project,
        user: User,
        role: ProjectRole,
        added_by: User
    ) -> ProjectMember:
        """Add user to project (admin+ can add)."""

    async def update_member_role(
        self,
        member: ProjectMember,
        new_role: ProjectRole,
        updated_by: User
    ) -> ProjectMember:
        """Change member role (admin+ can change, can't demote owner)."""

    async def remove_member(
        self,
        member: ProjectMember,
        removed_by: User
    ) -> bool:
        """Remove member from project (admin+ can remove, can't remove owner)."""
```

### Step 2.3: Permission Checks

```python
    def can_view(self, project: Project, user: User) -> bool:
        """Check if user can view project."""

    def can_edit(self, project: Project, user: User) -> bool:
        """Check if user can edit project (admin+)."""

    def can_manage_members(self, project: Project, user: User) -> bool:
        """Check if user can manage members (admin+)."""

    def can_delete(self, project: Project, user: User) -> bool:
        """Check if user can delete project (owner only)."""
```

---

## Task 3: Project API (P0.3.3)

**Files to create:**
- `src/groundwork/projects/routes.py`

### API Endpoints

| Method | Endpoint | Description | Auth |
|--------|----------|-------------|------|
| GET | `/api/v1/projects` | List user's projects | Required |
| POST | `/api/v1/projects` | Create project | Required |
| GET | `/api/v1/projects/{key}` | Get project details | Required |
| PATCH | `/api/v1/projects/{key}` | Update project | Admin+ |
| DELETE | `/api/v1/projects/{key}` | Delete project | Owner |
| POST | `/api/v1/projects/{key}/archive` | Archive project | Owner |
| POST | `/api/v1/projects/{key}/restore` | Restore project | Owner |
| GET | `/api/v1/projects/{key}/members` | List members | Member+ |
| POST | `/api/v1/projects/{key}/members` | Add member | Admin+ |
| PATCH | `/api/v1/projects/{key}/members/{id}` | Update member role | Admin+ |
| DELETE | `/api/v1/projects/{key}/members/{id}` | Remove member | Admin+ |

---

## Task 4: Project UI (P0.3.4)

**Files to create:**
- `src/groundwork/views/projects.py`
- `src/groundwork/templates/projects/list.html`
- `src/groundwork/templates/projects/detail.html`
- `src/groundwork/templates/projects/create.html`
- `src/groundwork/templates/projects/settings.html`
- `src/groundwork/templates/projects/members.html`
- `src/groundwork/templates/components/project_card.html`
- `src/groundwork/templates/components/project_switcher.html`

### View Routes

| Route | Template | Description |
|-------|----------|-------------|
| GET `/projects` | `projects/list.html` | Project list (cards) |
| GET `/projects/new` | `projects/create.html` | Create project form |
| POST `/projects` | - | Handle create (redirect) |
| GET `/projects/{key}` | `projects/detail.html` | Project overview |
| GET `/projects/{key}/settings` | `projects/settings.html` | Project settings |
| POST `/projects/{key}/settings` | - | Handle update |
| GET `/projects/{key}/members` | `projects/members.html` | Member management |

---

## Task 5: Testing (P0.3.5)

**Files to create:**
- `tests/projects/__init__.py`
- `tests/projects/test_models.py`
- `tests/projects/test_services.py`
- `tests/projects/test_routes.py`
- `tests/projects/test_views.py`
- `tests/projects/conftest.py` (fixtures)

### Test Coverage Requirements

- [ ] Project CRUD operations
- [ ] Project key validation (unique, uppercase, alphanumeric)
- [ ] Membership add/remove/update
- [ ] Role-based permissions
- [ ] Archive/restore functionality
- [ ] API endpoint tests
- [ ] View route tests

---

## Execution Order

1. **Task 1:** Data Layer - Models, schemas, repository, migration
2. **Task 2:** Service Layer - Business logic, permissions
3. **Task 3:** API Routes - REST endpoints
4. **Task 4:** UI - Templates and view routes
5. **Task 5:** Testing - Unit and integration tests

---

## Deliverables Checklist

From overview.md:

- [ ] User can create/edit/delete projects
- [ ] Project membership with roles works
- [ ] Project key uniqueness enforced
- [ ] Archive/restore functionality works
- [ ] 80%+ test coverage on project module

---

## Notes for Context Restoration

If context is lost, reference:
- This plan: `docs/plans/2026-01-19-p0.3-project-management.md`
- Full roadmap: `overview.md` (in repo root or worktree)
- P0.2 is complete (Auth, Users, Roles, UI templates)
- Branch strategy: Create `feature/p0.3-projects` from `main`
