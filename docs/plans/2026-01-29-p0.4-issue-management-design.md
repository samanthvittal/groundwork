# P0.4 - Issue Management Foundation Design

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Implement core issue management - create/edit/delete issues with types, statuses, labels, and subtasks

**Architecture:** Repository pattern for data, Service layer for business logic, FastAPI routes for API, Jinja2 templates for UI

**Tech Stack:** FastAPI, SQLAlchemy 2.0 async, PostgreSQL, HTMX, Jinja2

**Depends On:** P0.3 Project Management (completed)

**Estimated Effort:** 2 weeks

---

## Overview

P0.4 adds the ability for users to:
- Create, edit, and delete issues within projects
- Assign issue types (Task, Bug, Story, Epic) and statuses (To Do, In Progress, Done)
- Set priority and assignee
- Create subtasks (parent-child relationships)
- Manage labels for categorization

**Scope Decisions:**
- Issue links (blocks, relates to, duplicates) deferred to later phase
- Focus on parent-child subtasks only for relationships

---

## Data Models

### Enums

```python
class StatusCategory(str, Enum):
    TODO = "todo"
    IN_PROGRESS = "in_progress"
    DONE = "done"

class Priority(str, Enum):
    CRITICAL = "critical"
    HIGH = "high"
    MEDIUM = "medium"
    LOW = "low"
    NONE = "none"
```

### IssueType Model

```python
class IssueType(Base):
    __tablename__ = "issue_types"

    id: Mapped[UUID]
    project_id: Mapped[UUID | None]  # NULL = system default
    name: Mapped[str]  # e.g., "Task", "Bug", "Story", "Epic"
    icon: Mapped[str]  # icon identifier
    color: Mapped[str]  # hex color
    is_subtask: Mapped[bool]  # can this type be a subtask?
    position: Mapped[int]  # display order
    created_at: Mapped[datetime]
```

### Status Model

```python
class Status(Base):
    __tablename__ = "statuses"

    id: Mapped[UUID]
    project_id: Mapped[UUID | None]  # NULL = system default
    name: Mapped[str]  # e.g., "To Do", "In Progress", "Done"
    category: Mapped[StatusCategory]
    color: Mapped[str]
    position: Mapped[int]  # display order
    created_at: Mapped[datetime]
```

### Issue Model

```python
class Issue(Base):
    __tablename__ = "issues"

    id: Mapped[UUID]
    project_id: Mapped[UUID]  # FK to projects
    key: Mapped[str]  # e.g., "PROJ-123", unique
    issue_number: Mapped[int]  # auto-increment per project
    title: Mapped[str]
    description: Mapped[str | None]
    type_id: Mapped[UUID]  # FK to issue_types
    status_id: Mapped[UUID]  # FK to statuses
    priority: Mapped[Priority]
    assignee_id: Mapped[UUID | None]  # FK to users
    reporter_id: Mapped[UUID]  # FK to users
    parent_id: Mapped[UUID | None]  # FK to issues (for subtasks)
    created_at: Mapped[datetime]
    updated_at: Mapped[datetime]
    deleted_at: Mapped[datetime | None]  # soft delete

    # Relationships
    project: Mapped["Project"]
    type: Mapped["IssueType"]
    status: Mapped["Status"]
    assignee: Mapped["User | None"]
    reporter: Mapped["User"]
    parent: Mapped["Issue | None"]
    subtasks: Mapped[list["Issue"]]
    labels: Mapped[list["Label"]]
```

### Label Model

```python
class Label(Base):
    __tablename__ = "labels"

    id: Mapped[UUID]
    project_id: Mapped[UUID]  # FK to projects
    name: Mapped[str]
    color: Mapped[str]
    created_at: Mapped[datetime]

class IssueLabel(Base):
    __tablename__ = "issue_labels"

    issue_id: Mapped[UUID]  # FK to issues
    label_id: Mapped[UUID]  # FK to labels
    created_at: Mapped[datetime]
```

---

## Issue Key Generation

Each issue gets a unique key in format `PROJECT-123`:

```python
async def generate_issue_key(self, project_id: UUID) -> tuple[str, int]:
    """Generate next issue key for project with locking."""
    # Use SELECT FOR UPDATE to prevent race conditions
    result = await self.db.execute(
        select(func.coalesce(func.max(Issue.issue_number), 0))
        .where(Issue.project_id == project_id)
        .with_for_update()
    )
    max_number = result.scalar() or 0
    next_number = max_number + 1

    # Get project key
    project = await self.db.get(Project, project_id)
    key = f"{project.key}-{next_number}"

    return key, next_number
```

---

## Service Layer

### IssueService

```python
class IssueService:
    def __init__(self, db: AsyncSession):
        self.db = db

    # CRUD Operations
    async def create_issue(
        self,
        project_id: UUID,
        title: str,
        type_id: UUID,
        reporter_id: UUID,
        status_id: UUID | None = None,
        priority: Priority = Priority.MEDIUM,
        description: str | None = None,
        assignee_id: UUID | None = None,
        parent_id: UUID | None = None,
    ) -> Issue

    async def get_issue(self, issue_id: UUID) -> Issue | None
    async def get_issue_by_key(self, key: str) -> Issue | None

    async def update_issue(
        self,
        issue_id: UUID,
        title: str | None = None,
        description: str | None = None,
        type_id: UUID | None = None,
        status_id: UUID | None = None,
        priority: Priority | None = None,
        assignee_id: UUID | None = None,
    ) -> Issue | None

    async def delete_issue(self, issue_id: UUID) -> bool  # soft delete
    async def restore_issue(self, issue_id: UUID) -> Issue | None

    # Listing & Filtering
    async def list_issues(
        self,
        project_id: UUID,
        status_category: StatusCategory | None = None,
        type_id: UUID | None = None,
        assignee_id: UUID | None = None,
        priority: Priority | None = None,
        label_id: UUID | None = None,
        parent_id: UUID | None = None,
        search: str | None = None,
        include_deleted: bool = False,
        skip: int = 0,
        limit: int = 50,
    ) -> list[Issue]

    # Status Management
    async def change_status(
        self,
        issue_id: UUID,
        status_id: UUID,
    ) -> Issue | None

    # Subtask Management
    async def set_parent(self, issue_id: UUID, parent_id: UUID | None) -> Issue | None
    async def list_subtasks(self, parent_id: UUID) -> list[Issue]

    # Label Management
    async def add_label(self, issue_id: UUID, label_id: UUID) -> Issue | None
    async def remove_label(self, issue_id: UUID, label_id: UUID) -> Issue | None

    # Permission Checks
    async def user_can_view(self, issue_id: UUID, user_id: UUID) -> bool
    async def user_can_edit(self, issue_id: UUID, user_id: UUID) -> bool
    async def user_can_delete(self, issue_id: UUID, user_id: UUID) -> bool
```

### LabelService

```python
class LabelService:
    async def create_label(self, project_id: UUID, name: str, color: str) -> Label
    async def get_label(self, label_id: UUID) -> Label | None
    async def update_label(self, label_id: UUID, name: str | None, color: str | None) -> Label | None
    async def delete_label(self, label_id: UUID) -> bool
    async def list_labels(self, project_id: UUID) -> list[Label]
```

---

## Permission Model

| Action | Required Role |
|--------|---------------|
| View issues | VIEWER+ (project member) |
| Create issues | MEMBER+ |
| Edit issues | MEMBER+ (or assignee) |
| Delete issues | ADMIN+ (or reporter within 24h) |
| Manage labels | ADMIN+ |

---

## API Endpoints

### Issue Endpoints

| Method | Endpoint | Description | Permission |
|--------|----------|-------------|------------|
| GET | `/api/v1/projects/{key}/issues` | List issues with filters | VIEWER+ |
| POST | `/api/v1/projects/{key}/issues` | Create issue | MEMBER+ |
| GET | `/api/v1/issues/{key}` | Get issue by key | VIEWER+ |
| PATCH | `/api/v1/issues/{key}` | Update issue fields | MEMBER+ |
| DELETE | `/api/v1/issues/{key}` | Soft delete issue | ADMIN+ |

### Subtask Endpoints

| Method | Endpoint | Description | Permission |
|--------|----------|-------------|------------|
| GET | `/api/v1/issues/{key}/subtasks` | List subtasks | VIEWER+ |
| POST | `/api/v1/issues/{key}/subtasks` | Create subtask | MEMBER+ |
| DELETE | `/api/v1/issues/{key}/subtasks/{child_key}` | Remove subtask | MEMBER+ |

### Label Endpoints

| Method | Endpoint | Description | Permission |
|--------|----------|-------------|------------|
| GET | `/api/v1/projects/{key}/labels` | List project labels | VIEWER+ |
| POST | `/api/v1/projects/{key}/labels` | Create label | ADMIN+ |
| PATCH | `/api/v1/labels/{id}` | Update label | ADMIN+ |
| DELETE | `/api/v1/labels/{id}` | Delete label | ADMIN+ |
| POST | `/api/v1/issues/{key}/labels` | Add label to issue | MEMBER+ |
| DELETE | `/api/v1/issues/{key}/labels/{id}` | Remove label | MEMBER+ |

### Query Parameters for List Issues

```
GET /api/v1/projects/{key}/issues?
  status=todo,in_progress    # filter by status category or ID
  type=bug,task              # filter by type name or ID
  assignee=me,{user_id}      # filter by assignee
  priority=high,critical     # filter by priority
  label={label_id}           # filter by label
  parent={issue_key}         # filter subtasks of parent
  q=search+term              # text search in title/description
  sort=created_at,-priority  # sort fields (- for desc)
  page=1&per_page=50         # pagination
```

---

## UI Templates

### View Routes

| Route | Template | Description |
|-------|----------|-------------|
| GET `/projects/{id}/issues` | `issues/list.html` | Issue list with filters |
| GET `/projects/{id}/issues/new` | `issues/create.html` | Create issue form |
| POST `/projects/{id}/issues/new` | - | Handle create |
| GET `/issues/{key}` | `issues/detail.html` | Issue detail page |
| GET `/issues/{key}/edit` | `issues/edit.html` | Edit issue form |
| POST `/issues/{key}/edit` | - | Handle update |
| POST `/issues/{key}/delete` | - | Handle delete |

### Template Files

```
src/groundwork/templates/issues/
‚îú‚îÄ‚îÄ list.html          # Issue list with filters, table view
‚îú‚îÄ‚îÄ detail.html        # Issue detail with subtasks, labels
‚îú‚îÄ‚îÄ create.html        # Create issue form
‚îú‚îÄ‚îÄ edit.html          # Edit issue form
‚îî‚îÄ‚îÄ _issue_row.html    # Partial for HTMX updates
```

### Issue List Page Features

- Filter bar: status, type, assignee, priority dropdowns
- Search box for text search
- Table columns: Key, Title, Type, Status, Priority, Assignee
- Sortable column headers
- Pagination controls
- "New Issue" button

### Issue Detail Page Features

- Header: Key, Title, Type badge, Status badge
- Sidebar: Assignee, Reporter, Priority, Labels, Dates
- Main content: Description (markdown rendered)
- Subtasks section: List of child issues
- Action buttons: Edit, Delete

### HTMX Interactions

- Inline status change via dropdown
- Quick assignee change
- Add/remove labels without reload
- Filter changes update list dynamically

---

## Default Seed Data

### Default Issue Types

| Name | Icon | Color | Is Subtask |
|------|------|-------|------------|
| Epic | üéØ | #8b5cf6 (purple) | No |
| Story | üìñ | #22c55e (green) | No |
| Task | ‚úì | #3b82f6 (blue) | Yes |
| Bug | üêõ | #ef4444 (red) | Yes |

### Default Statuses

| Name | Category | Color |
|------|----------|-------|
| To Do | TODO | #6b7280 (gray) |
| In Progress | IN_PROGRESS | #3b82f6 (blue) |
| Done | DONE | #22c55e (green) |

---

## Implementation Tasks

### Task 1: Data Layer (Models & Migration)

**Files to create:**
- `src/groundwork/issues/__init__.py`
- `src/groundwork/issues/models.py`
- `alembic/versions/xxxx_add_issues.py`

**Steps:**
1. Create IssueType, Status, Issue, Label, IssueLabel models
2. Create Priority, StatusCategory enums
3. Generate Alembic migration
4. Add seed data function for defaults

### Task 2: Service Layer

**Files to create:**
- `src/groundwork/issues/services.py`

**Steps:**
1. Implement IssueService with CRUD
2. Implement issue key generation with locking
3. Implement subtask management
4. Implement LabelService
5. Add permission checks

### Task 3: Pydantic Schemas

**Files to create:**
- `src/groundwork/issues/schemas.py`

**Steps:**
1. Create IssueCreate, IssueUpdate, IssueResponse schemas
2. Create LabelCreate, LabelUpdate, LabelResponse schemas
3. Create IssueTypeResponse, StatusResponse schemas
4. Create filter/pagination schemas

### Task 4: API Routes

**Files to create:**
- `src/groundwork/issues/routes.py`

**Steps:**
1. Implement issue CRUD endpoints
2. Implement subtask endpoints
3. Implement label endpoints
4. Register router in main.py

### Task 5: UI Views

**Files to create:**
- `src/groundwork/views/issues.py`
- `src/groundwork/templates/issues/list.html`
- `src/groundwork/templates/issues/detail.html`
- `src/groundwork/templates/issues/create.html`
- `src/groundwork/templates/issues/edit.html`
- `src/groundwork/templates/issues/_issue_row.html`

**Steps:**
1. Create view routes
2. Create list template with filters
3. Create detail template
4. Create create/edit forms
5. Add HTMX interactions

### Task 6: Testing

**Files to create:**
- `tests/issues/__init__.py`
- `tests/issues/test_models.py`
- `tests/issues/test_services.py`
- `tests/issues/test_routes.py`
- `tests/views/test_issues_views.py`

**Steps:**
1. Create test fixtures (issue factory)
2. Test model creation and relationships
3. Test service methods
4. Test API endpoints
5. Test view routes
6. Aim for 80%+ coverage

---

## Execution Order

```
Task 1 (Models) ‚Üí Task 2 (Services) ‚Üí Task 3 (Schemas) ‚Üí Task 4 (API) ‚Üí Task 5 (UI) ‚Üí Task 6 (Tests)
```

---

## Deliverables Checklist

From overview.md:

- [ ] User can create/edit/delete issues
- [ ] Issue keys auto-generate correctly (PROJ-1, PROJ-2, ...)
- [ ] Status transitions work
- [ ] Parent-child subtasks work
- [ ] Labels can be managed
- [ ] 80%+ test coverage

---

## Notes for Context Restoration

If context is lost, reference:
- This plan: `docs/plans/2026-01-29-p0.4-issue-management-design.md`
- Full roadmap: `overview.md`
- P0.3 is complete (Projects, Members, Roles)
- Branch strategy: Create `feature/p0.4-issues` from `main`

---

## Deferred to Later Phases

- Issue links (blocks, relates to, duplicates) - P0.5 or later
- Workflow engine (custom status transitions) - P1.5
- Custom fields - P1.4
- Time tracking - P1.3
