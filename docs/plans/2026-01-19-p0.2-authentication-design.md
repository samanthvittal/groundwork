# P0.2 Authentication & User Management - Design Document

> **Status**: Approved
> **Created**: 2026-01-19
> **Depends On**: P0.1 Infrastructure

---

## Overview

P0.2 establishes the authentication and user management foundation for Groundwork. It implements a strategy-pattern auth system (extensible for future Keycloak support), admin-controlled user creation, full RBAC with custom roles, and server-rendered UI with HTMX.

---

## Key Decisions

| Decision | Choice | Rationale |
|----------|--------|-----------|
| Auth architecture | Strategy pattern | LocalAuthProvider now, extensible for Keycloak later |
| Setup wizard | Guided (4 steps) | Instance settings → admin account → optional SMTP |
| User registration | Admin-controlled only | Self-hosted apps serve known teams; prevents abuse |
| Email verification | Required when SMTP configured | Respects admin's configuration choice |
| Token strategy | Access (15min) + Refresh (7 days) | Industry standard, short access limits exposure |
| Token storage | HTTP-only cookies | Works with HTMX, prevents XSS token theft |
| Authorization | Full RBAC, system-level | Custom roles with granular permissions |
| Default roles | Admin, Manager, Member, Guest | Covers most team structures |
| Password policy | 8 char minimum | NIST guidance; complexity rules lead to weaker passwords |
| Avatar storage | Local filesystem | Simple, no external dependencies |
| UI approach | Jinja2 + HTMX | Matches project philosophy, no JS frameworks |

---

## Architecture

### Module Structure

```
src/groundwork/
├── auth/
│   ├── __init__.py
│   ├── providers/
│   │   ├── __init__.py
│   │   ├── base.py              # AuthProvider ABC
│   │   └── local.py             # LocalAuthProvider
│   ├── models.py                # User, Role, Permission, RefreshToken
│   ├── schemas.py               # Pydantic request/response models
│   ├── services.py              # AuthService (uses provider)
│   ├── dependencies.py          # get_current_user, require_permission
│   ├── routes.py                # Auth API endpoints
│   └── utils.py                 # Password hashing (Argon2), JWT utilities
├── users/
│   ├── __init__.py
│   ├── services.py              # UserService (CRUD operations)
│   ├── routes.py                # User management API
│   └── schemas.py               # User Pydantic models
├── setup/
│   ├── __init__.py
│   ├── models.py                # InstanceConfig
│   ├── services.py              # SetupService
│   ├── routes.py                # Setup wizard endpoints
│   └── middleware.py            # First-run detection
├── static/
│   ├── css/
│   │   ├── base.css             # Reset, variables, typography
│   │   ├── layout.css           # TopBar, Sidebar, Footer styles
│   │   ├── components.css       # Buttons, forms, cards, tables
│   │   ├── utilities.css        # Spacing, colors, helpers
│   │   └── themes/
│   │       ├── light.css
│   │       └── dark.css
│   ├── js/
│   │   └── app.js               # HTMX config, theme toggle, dropdowns
│   └── images/
│       └── logo.svg
└── templates/
    ├── base.html
    ├── layouts/
    │   ├── app.html             # Logged-in layout (TopBar + Sidebar)
    │   └── public.html          # Public layout (login, setup)
    ├── components/
    │   ├── topbar.html          # Logo left, user menu right
    │   ├── sidebar.html         # Navigation menu
    │   ├── footer.html          # Copyright, version
    │   └── user_menu.html       # Dropdown: Profile, Preferences, Logout
    ├── auth/
    │   ├── login.html
    │   ├── password_reset.html
    │   └── password_reset_confirm.html
    ├── setup/
    │   ├── welcome.html
    │   ├── instance.html
    │   ├── admin.html
    │   ├── smtp.html
    │   └── complete.html
    ├── users/
    │   ├── list.html
    │   ├── detail.html
    │   └── create.html
    ├── profile/
    │   ├── view.html
    │   ├── edit.html
    │   └── settings.html
    └── partials/
        ├── user_row.html
        ├── flash_message.html
        └── form_errors.html
```

---

## Data Models

### User

```python
class User(Base):
    __tablename__ = "users"

    id: Mapped[UUID] = mapped_column(primary_key=True, default=uuid4)
    email: Mapped[str] = mapped_column(String(255), unique=True, index=True)
    hashed_password: Mapped[str] = mapped_column(String(255))
    first_name: Mapped[str] = mapped_column(String(100))
    last_name: Mapped[str] = mapped_column(String(100))
    display_name: Mapped[str | None] = mapped_column(String(200))
    avatar_path: Mapped[str | None] = mapped_column(String(500))
    is_active: Mapped[bool] = mapped_column(default=True)
    email_verified: Mapped[bool] = mapped_column(default=False)
    role_id: Mapped[UUID] = mapped_column(ForeignKey("roles.id"))
    timezone: Mapped[str] = mapped_column(String(50), default="UTC")
    language: Mapped[str] = mapped_column(String(10), default="en")
    theme: Mapped[str] = mapped_column(String(20), default="system")
    created_at: Mapped[datetime] = mapped_column(default=func.now())
    updated_at: Mapped[datetime] = mapped_column(default=func.now(), onupdate=func.now())
    last_login_at: Mapped[datetime | None] = mapped_column(nullable=True)

    role: Mapped["Role"] = relationship(back_populates="users")
```

### Role & Permission

```python
class Role(Base):
    __tablename__ = "roles"

    id: Mapped[UUID] = mapped_column(primary_key=True, default=uuid4)
    name: Mapped[str] = mapped_column(String(100), unique=True)
    description: Mapped[str] = mapped_column(String(500))
    is_system: Mapped[bool] = mapped_column(default=False)  # Prevents deletion
    created_at: Mapped[datetime] = mapped_column(default=func.now())

    users: Mapped[list["User"]] = relationship(back_populates="role")
    permissions: Mapped[list["Permission"]] = relationship(
        secondary="role_permissions", back_populates="roles"
    )

    def has_permission(self, codename: str) -> bool:
        return any(p.codename == codename for p in self.permissions)


class Permission(Base):
    __tablename__ = "permissions"

    id: Mapped[UUID] = mapped_column(primary_key=True, default=uuid4)
    codename: Mapped[str] = mapped_column(String(100), unique=True)
    description: Mapped[str] = mapped_column(String(500))

    roles: Mapped[list["Role"]] = relationship(
        secondary="role_permissions", back_populates="permissions"
    )


class RolePermission(Base):
    __tablename__ = "role_permissions"

    role_id: Mapped[UUID] = mapped_column(ForeignKey("roles.id"), primary_key=True)
    permission_id: Mapped[UUID] = mapped_column(ForeignKey("permissions.id"), primary_key=True)
```

### RefreshToken

```python
class RefreshToken(Base):
    __tablename__ = "refresh_tokens"

    id: Mapped[UUID] = mapped_column(primary_key=True, default=uuid4)
    user_id: Mapped[UUID] = mapped_column(ForeignKey("users.id"))
    token_hash: Mapped[str] = mapped_column(String(255), index=True)
    expires_at: Mapped[datetime]
    revoked_at: Mapped[datetime | None] = mapped_column(nullable=True)
    created_at: Mapped[datetime] = mapped_column(default=func.now())

    user: Mapped["User"] = relationship()
```

### InstanceConfig

```python
class InstanceConfig(Base):
    __tablename__ = "instance_config"

    id: Mapped[UUID] = mapped_column(primary_key=True, default=uuid4)
    instance_name: Mapped[str] = mapped_column(String(200))
    base_url: Mapped[str] = mapped_column(String(500))
    setup_completed: Mapped[bool] = mapped_column(default=False)
    smtp_host: Mapped[str | None] = mapped_column(String(255), nullable=True)
    smtp_port: Mapped[int | None] = mapped_column(nullable=True)
    smtp_username: Mapped[str | None] = mapped_column(String(255), nullable=True)
    smtp_password: Mapped[str | None] = mapped_column(String(255), nullable=True)
    smtp_from_address: Mapped[str | None] = mapped_column(String(255), nullable=True)
    smtp_configured: Mapped[bool] = mapped_column(default=False)
    created_at: Mapped[datetime] = mapped_column(default=func.now())
    updated_at: Mapped[datetime] = mapped_column(default=func.now(), onupdate=func.now())
```

---

## RBAC Permissions

### System Permissions

| Codename | Description |
|----------|-------------|
| `users:create` | Create new users |
| `users:read` | View user list and details |
| `users:update` | Edit user profiles and roles |
| `users:delete` | Deactivate/delete users |
| `roles:manage` | Create, edit, delete custom roles |
| `settings:manage` | Modify instance settings, SMTP config |
| `audit:read` | View audit logs (future) |

### Default Role Permissions

| Role | Permissions | System Role |
|------|-------------|-------------|
| Admin | All permissions | Yes |
| Manager | `users:read`, `users:create`, `users:update` | Yes |
| Member | (none - can use app features) | Yes |
| Guest | (none - read-only in projects) | Yes |

---

## API Endpoints

### Auth Routes (`/api/v1/auth/`)

| Endpoint | Method | Description | Auth |
|----------|--------|-------------|------|
| `/login` | POST | Email + password → set cookies | No |
| `/logout` | POST | Revoke refresh token, clear cookies | Yes |
| `/refresh` | POST | Refresh token → new access token | Cookie |
| `/me` | GET | Get current user info | Yes |
| `/password-reset` | POST | Request reset email | No |
| `/password-reset/{token}` | PUT | Confirm reset | No |

### User Management Routes (`/api/v1/users/`)

| Endpoint | Method | Description | Permission |
|----------|--------|-------------|------------|
| `/` | GET | List users (paginated) | `users:read` |
| `/` | POST | Create user | `users:create` |
| `/{id}` | GET | Get user details | `users:read` |
| `/{id}` | PATCH | Update user | `users:update` |
| `/{id}` | DELETE | Deactivate user | `users:delete` |
| `/{id}/password` | PUT | Reset user password | `users:update` |

### Profile Routes (`/api/v1/profile/`)

| Endpoint | Method | Description | Auth |
|----------|--------|-------------|------|
| `/` | GET | Get own profile | Yes |
| `/` | PATCH | Update own profile | Yes |
| `/password` | PUT | Change own password | Yes |
| `/avatar` | PUT | Upload avatar | Yes |
| `/settings` | GET | Get preferences | Yes |
| `/settings` | PATCH | Update preferences | Yes |

### Role Management Routes (`/api/v1/roles/`)

| Endpoint | Method | Description | Permission |
|----------|--------|-------------|------------|
| `/` | GET | List all roles | `roles:manage` |
| `/` | POST | Create custom role | `roles:manage` |
| `/{id}` | GET | Get role details | `roles:manage` |
| `/{id}` | PATCH | Update role | `roles:manage` |
| `/{id}` | DELETE | Delete role (non-system) | `roles:manage` |
| `/permissions` | GET | List all permissions | `roles:manage` |

---

## Setup Wizard Flow

### First-Run Detection

Middleware checks if `InstanceConfig` exists with `setup_completed=True`. If not, all routes redirect to `/setup`.

### Steps

1. **Welcome** (`/setup`)
   - Brief introduction
   - "Let's set up Groundwork" button

2. **Instance Settings** (`/setup/instance`)
   - Instance name (required)
   - Base URL (auto-detected, editable)

3. **Admin Account** (`/setup/admin`)
   - Email (required)
   - First name, last name (required)
   - Password + confirmation (required, 8 char min)
   - Creates user with Admin role

4. **Email Configuration** (`/setup/smtp`) - Optional
   - SMTP host, port, username, password
   - From address
   - "Test connection" button
   - "Skip for now" option

5. **Complete** (`/setup/complete`)
   - Summary of configuration
   - "Start using Groundwork" button
   - Sets `setup_completed=True`

---

## Authentication Flow

### Login

1. User submits email + password to `POST /api/v1/auth/login`
2. `LocalAuthProvider.authenticate()` validates credentials
3. Generate access token (JWT, 15 min expiry)
4. Generate refresh token (random, 7 days expiry)
5. Store refresh token hash in database
6. Set both tokens as HTTP-only cookies
7. Return user info + CSRF token

### Token Refresh

1. Client sends request with expired access token
2. Server returns 401
3. HTMX intercepts, calls `POST /api/v1/auth/refresh`
4. Server validates refresh token from cookie
5. Issue new access token
6. Update cookie

### Logout

1. `POST /api/v1/auth/logout`
2. Mark refresh token as revoked in database
3. Clear both cookies
4. Redirect to login

### Password Reset (when SMTP configured)

1. User requests reset via email
2. Generate reset token (1 hour expiry)
3. Send email with reset link
4. User clicks link, sets new password
5. Invalidate all refresh tokens for user

---

## UI Components

### TopBar (Header)

- **Left**: Logo + instance name
- **Right**: User menu dropdown
  - Avatar + display name
  - Profile link
  - Preferences link
  - Logout button

### Sidebar

- Navigation links (context-dependent)
- Collapsible on mobile

### Footer

- Copyright notice
- Version number
- Links (docs, support)

### HTMX Patterns

- Forms: `hx-post` with `hx-swap="outerHTML"` for validation
- Success: `HX-Redirect` header for navigation
- Flash messages: `hx-swap-oob` injection
- Lists: `hx-get` for pagination/filtering
- CSRF: Token in meta tag, included via `hx-headers`

---

## Testing Strategy

### Test Files

```
tests/
├── auth/
│   ├── test_providers.py      # LocalAuthProvider unit tests
│   ├── test_services.py       # AuthService unit tests
│   ├── test_routes.py         # Auth API integration tests
│   ├── test_dependencies.py   # Permission checking tests
│   └── test_utils.py          # Password hashing, JWT tests
├── users/
│   ├── test_routes.py         # User CRUD API tests
│   └── test_services.py       # UserService tests
├── setup/
│   └── test_wizard.py         # Setup flow integration tests
└── factories/
    ├── user.py                # UserFactory
    └── role.py                # RoleFactory
```

### Key Fixtures

```python
@pytest.fixture
def admin_user(db_session) -> User

@pytest.fixture
def member_user(db_session) -> User

@pytest.fixture
def authenticated_client(client, admin_user) -> AsyncClient

@pytest.fixture
def mock_smtp()
```

### Coverage Targets

- Auth providers: 95%+
- Permission dependencies: 100%
- API routes: 90%+
- Overall P0.2: 80%+

---

## Deliverables

- [ ] User, Role, Permission, RefreshToken models with migrations
- [ ] InstanceConfig model for setup state
- [ ] AuthProvider strategy with LocalAuthProvider
- [ ] Setup wizard (4 steps + completion)
- [ ] Login, logout, token refresh, password reset flows
- [ ] User management CRUD (admin only)
- [ ] Profile and preferences pages
- [ ] RBAC permission system with 4 default roles
- [ ] Reusable CSS (layout, components, themes)
- [ ] HTMX-powered UI with TopBar, Sidebar, Footer
- [ ] 80%+ test coverage
