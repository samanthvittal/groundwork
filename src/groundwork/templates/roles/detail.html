{% extends "layouts/app.html" %}

{% block title %}{{ role.name }} - Role Details{% endblock %}

{% block page_header %}
<div class="page-header">
    <div class="page-header__content">
        <nav class="breadcrumbs">
            <a href="/roles" class="breadcrumbs__link">Roles</a>
            <span class="breadcrumbs__separator">/</span>
            <span class="breadcrumbs__current">{{ role.name }}</span>
        </nav>
        <h1 class="page-header__title">
            {{ role.name }}
            {% if role.is_system %}
            <span class="badge badge--info">System</span>
            {% endif %}
        </h1>
        <p class="page-header__description">{{ role.description }}</p>
    </div>
    <div class="page-header__actions">
        {% if can_update %}
        <a href="/roles/{{ role.id }}/edit" class="btn btn--secondary">Edit Role</a>
        {% endif %}
        {% if can_delete and not role.is_system %}
        <form method="post" action="/roles/{{ role.id }}/delete" style="display: inline;" onsubmit="return confirm('Are you sure you want to delete this role? Users with this role will need to be reassigned.');">
            <button type="submit" class="btn btn--danger">Delete Role</button>
        </form>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block content %}
<div class="role-detail">
    {% if success %}
    <div class="alert alert--success" style="margin-bottom: var(--spacing-4);">
        <div class="alert__content">
            <p class="alert__message">{{ success }}</p>
        </div>
    </div>
    {% endif %}

    {% if error %}
    <div class="alert alert--error" style="margin-bottom: var(--spacing-4);">
        <div class="alert__content">
            <p class="alert__message">{{ error }}</p>
        </div>
    </div>
    {% endif %}

    <div class="role-detail-grid">
        <!-- Permissions Card -->
        <div class="card">
            <div class="card__header">
                <h3 class="card__title">Permissions ({{ role.permissions|length }})</h3>
            </div>
            <div class="card__body">
                {% if role.permissions %}
                <div class="permissions-list">
                    {% set grouped_perms = {} %}
                    {% for perm in role.permissions %}
                        {% set category = perm.codename.split(':')[0] %}
                        {% if category not in grouped_perms %}
                            {% set _ = grouped_perms.update({category: []}) %}
                        {% endif %}
                        {% set _ = grouped_perms[category].append(perm) %}
                    {% endfor %}

                    {% for category, perms in grouped_perms.items() %}
                    <div class="permission-group">
                        <h4 class="permission-group__title">{{ category|capitalize }}</h4>
                        <ul class="permission-group__list">
                            {% for perm in perms %}
                            <li class="permission-item">
                                <span class="permission-item__code">{{ perm.codename }}</span>
                                <span class="permission-item__description">{{ perm.description }}</span>
                            </li>
                            {% endfor %}
                        </ul>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <p class="text-secondary">No permissions assigned to this role.</p>
                {% endif %}
            </div>
        </div>

        <!-- Users Card -->
        <div class="card">
            <div class="card__header">
                <h3 class="card__title">Users with this Role ({{ role.users|length }})</h3>
            </div>
            <div class="card__body">
                {% if role.users %}
                <ul class="users-list">
                    {% for user in role.users %}
                    <li class="user-item">
                        <div class="avatar avatar--sm">
                            {% if user.avatar_path %}
                                <img src="{{ user.avatar_path }}" alt="{{ user.full_name }}">
                            {% else %}
                                {{ user.first_name[0] }}{{ user.last_name[0] }}
                            {% endif %}
                        </div>
                        <div class="user-item__info">
                            <a href="/users/{{ user.id }}" class="user-item__name">{{ user.full_name }}</a>
                            <span class="user-item__email">{{ user.email }}</span>
                        </div>
                        {% if user.is_active %}
                        <span class="badge badge--success badge--sm">Active</span>
                        {% else %}
                        <span class="badge badge--secondary badge--sm">Inactive</span>
                        {% endif %}
                    </li>
                    {% endfor %}
                </ul>
                {% else %}
                <p class="text-secondary">No users have this role.</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<style>
.role-detail-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: var(--spacing-6);
    max-width: 1200px;
}

@media (max-width: 768px) {
    .role-detail-grid {
        grid-template-columns: 1fr;
    }
}

.breadcrumbs {
    display: flex;
    align-items: center;
    gap: var(--spacing-2);
    font-size: var(--font-size-sm);
    margin-bottom: var(--spacing-2);
}

.breadcrumbs__link {
    color: var(--color-text-secondary);
}

.breadcrumbs__link:hover {
    color: var(--color-primary);
}

.breadcrumbs__separator {
    color: var(--color-text-muted);
}

.breadcrumbs__current {
    color: var(--color-text);
}

.permissions-list {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-6);
}

.permission-group__title {
    font-size: var(--font-size-sm);
    font-weight: var(--font-weight-semibold);
    color: var(--color-text);
    text-transform: capitalize;
    margin-bottom: var(--spacing-2);
    padding-bottom: var(--spacing-2);
    border-bottom: 1px solid var(--color-border);
}

.permission-group__list {
    list-style: none;
    padding: 0;
    margin: 0;
    display: flex;
    flex-direction: column;
    gap: var(--spacing-2);
}

.permission-item {
    display: flex;
    flex-direction: column;
    gap: 2px;
}

.permission-item__code {
    font-size: var(--font-size-sm);
    font-weight: var(--font-weight-medium);
    color: var(--color-text);
    font-family: var(--font-mono);
}

.permission-item__description {
    font-size: var(--font-size-xs);
    color: var(--color-text-secondary);
}

.users-list {
    list-style: none;
    padding: 0;
    margin: 0;
    display: flex;
    flex-direction: column;
    gap: var(--spacing-3);
}

.user-item {
    display: flex;
    align-items: center;
    gap: var(--spacing-3);
    padding: var(--spacing-2) 0;
    border-bottom: 1px solid var(--color-border);
}

.user-item:last-child {
    border-bottom: none;
}

.user-item__info {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 2px;
    min-width: 0;
}

.user-item__name {
    font-size: var(--font-size-sm);
    font-weight: var(--font-weight-medium);
    color: var(--color-text);
}

.user-item__name:hover {
    color: var(--color-primary);
}

.user-item__email {
    font-size: var(--font-size-xs);
    color: var(--color-text-secondary);
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

.badge--sm {
    font-size: var(--font-size-xs);
    padding: 2px 6px;
}

.page-header__title .badge {
    vertical-align: middle;
    margin-left: var(--spacing-2);
}
</style>
{% endblock %}
