<!DOCTYPE html>
<html lang="en" data-theme="{{ theme|default('light') }}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="{% block meta_description %}Groundwork - Open source self-hosted project management{% endblock %}">

    <title>{% block title %}Groundwork{% endblock %}</title>

    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="{{ url_for('static', path='favicon.svg') }}">

    <!-- CSS -->
    <link rel="stylesheet" href="{{ url_for('static', path='css/base.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', path='css/layout.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', path='css/components.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', path='css/utilities.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', path='css/themes/light.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', path='css/themes/dark.css') }}">

    {% block head_extra %}{% endblock %}

    <!-- HTMX -->
    <script src="https://unpkg.com/htmx.org@2.0.4" integrity="sha384-HGfztofotfshcF7+8n44JQL2oJmowVChPTg48S+jvZoztPfvwD79OC/LTtG6dMp+" crossorigin="anonymous"></script>

    <!-- HTMX Configuration -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Configure HTMX to include CSRF token in all requests
            document.body.addEventListener('htmx:configRequest', function(event) {
                // Get CSRF token from meta tag or cookie
                const csrfToken = document.querySelector('meta[name="csrf-token"]')?.content;
                if (csrfToken) {
                    event.detail.headers['X-CSRF-Token'] = csrfToken;
                }
            });

            // Handle HTMX errors
            document.body.addEventListener('htmx:responseError', function(event) {
                console.error('HTMX request failed:', event.detail);
            });

            // Theme handling
            function getPreferredTheme() {
                const stored = localStorage.getItem('theme');
                if (stored) return stored;
                return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
            }

            function setTheme(theme) {
                document.documentElement.setAttribute('data-theme', theme);
                localStorage.setItem('theme', theme);
            }

            // Initialize theme
            setTheme(getPreferredTheme());

            // Listen for system theme changes
            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', function(e) {
                if (!localStorage.getItem('theme')) {
                    setTheme(e.matches ? 'dark' : 'light');
                }
            });

            // Expose theme toggle function globally
            window.toggleTheme = function() {
                const current = document.documentElement.getAttribute('data-theme');
                setTheme(current === 'dark' ? 'light' : 'dark');
            };
        });
    </script>

    {% block scripts_head %}{% endblock %}
</head>
<body hx-headers='{"X-Requested-With": "XMLHttpRequest"}'>
    <!-- CSRF Token -->
    <meta name="csrf-token" content="{{ csrf_token|default('') }}">

    <!-- Flash Messages Container (for HTMX OOB swaps) -->
    <div id="flash-messages" class="flash-messages" hx-swap-oob="true">
        {% block flash_messages %}
            {% if messages %}
                {% for message in messages %}
                    {% include "partials/flash_message.html" %}
                {% endfor %}
            {% endif %}
        {% endblock %}
    </div>

    {% block body %}
        <!-- Main content goes here -->
    {% endblock %}

    {% block scripts_body %}{% endblock %}
</body>
</html>
